resources:
- name: edge-network
  type: compute.v1.network
  properties:
    autoCreateSubnetworks: false
    routingConfig:
      routingMode: REGIONAL

- name: bastion-address
  type: compute.v1.address
  properties:
    region: us-west1
    addressType: EXTERNAL

- name: edge-firewall-rule
  type: compute.v1.firewall
  properties:
    priority: 65534
    sourceRanges:
    - "10.0.0.0/16"
    - "10.1.0.0/16"
    allowed:
    - IPProtocol: tcp
      ports:
      - "22"     
      - "1024-9999"      
    network: $(ref.edge-network.selfLink)

- name: router-firewall-rule
  type: compute.v1.firewall
  properties:
    priority: 1000
    sourceRanges:
    - "0.0.0.0/0"
    targetTags:
    - router
    allowed:
    - IPProtocol: tcp
      ports:      
      - "15999"
      - "9001"
      - "9443"
    network: $(ref.edge-network.selfLink)

- name: edgems-firewall-rule
  type: compute.v1.firewall
  properties:
    priority: 1000
    sourceRanges:
    - "0.0.0.0/0"
    targetTags:
    - edgems
    allowed:
    - IPProtocol: tcp
      ports:    
      - "8080"
      - "9000"
      - "9443"
    network: $(ref.edge-network.selfLink)

- name: bastion-firewall-rule
  type: compute.v1.firewall
  properties:
    priority: 65534
    targetTags:
    - bastion
    sourceRanges:
    - 0.0.0.0/0
    allowed:
    - IPProtocol: tcp
      ports:      
      - "22"
    network: $(ref.edge-network.selfLink)

- name: edge-subnetwork-west
  type: compute.v1.subnetwork
  properties:
    ipCidrRange: 10.0.0.0/16
    region: us-west1
    network: $(ref.edge-network.selfLink)

- name: edge-subnetwork-east
  type: compute.v1.subnetwork
  properties:
    ipCidrRange: 10.1.0.0/16
    region: us-east1
    network: $(ref.edge-network.selfLink)

- name: router-instance-group
  type: compute.v1.instanceGroup
  properties:
    region: us-west1
    zone: us-west1-c
    network: $(ref.edge-network.selfLink)
    namedPorts:
      - 
        name: http
        port: 9001
      - 
        name: https
        port: 9443

- name: router-healthcheck
  type: compute.v1.httpHealthCheck
  properties:
    port: 15999
    requestPath: /v1/servers/self/reachable 

- name: router-healthcheck-tls
  type: compute.v1.httpsHealthCheck
  properties:
    port: 15999
    requestPath: /v1/servers/self/reachable 

- name: router-backendservice-tls
  type: compute.v1.backendService
  properties:
    region: us-west1
    loadBalancingScheme: EXTERNAL
    portName: http
    protocol: HTTP
    backends:
      - balancingMode: UTILIZATION
        group: $(ref.router-instance-group.selfLink)
    healthChecks:
      - $(ref.router-healthcheck.selfLink)

- name: bastion
  type: compute.v1.instance
  properties:
    zone: us-west1-c
    machineType: zones/us-west1-c/machineTypes/f1-micro
    tags: 
      items:
      - bastion
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 10
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-west.selfLink)
      networkIP: 10.0.0.2
      accessConfigs:
        - natIP: $(ref.bastion-address.address)      

- name: ms-ds-n1
  type: compute.v1.instance
  properties:
    zone: us-west1-c
    machineType: zones/us-west1-c/machineTypes/n1-standard-1
    tags: 
      items:
      - edgems
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 50
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-west.selfLink)
      networkIP: 10.0.0.3
      accessConfigs:
        - 
          type: ONE_TO_ONE_NAT

- name: ds-n2
  type: compute.v1.instance
  properties:
    zone: us-west1-c
    machineType: zones/us-west1-c/machineTypes/n1-standard-1
    tags:
      items:
      - router
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 50
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-west.selfLink)
      networkIP: 10.0.0.4
      accessConfigs:
        - 
          type: ONE_TO_ONE_NAT

- name: ds-n3
  type: compute.v1.instance
  properties:
    zone: us-west1-c
    machineType: zones/us-west1-c/machineTypes/n1-standard-1
    tags:
      items:
      - router
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 50
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-west.selfLink)
      networkIP: 10.0.0.5
      accessConfigs:
        - 
          type: ONE_TO_ONE_NAT
- name: sax-n4
  type: compute.v1.instance
  properties:
    zone: us-east1-c
    machineType: zones/us-east1-c/machineTypes/n1-standard-1
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 50
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-east.selfLink)
      networkIP: 10.1.0.3
      accessConfigs:
        - 
          type: ONE_TO_ONE_NAT

- name: sax-n5
  type: compute.v1.instance
  properties:
    zone: us-east1-c
    machineType: zones/us-east1-c/machineTypes/n1-standard-1
    disks:
    - deviceName: boot
      type: PERSISTENT
      boot: true
      autoDelete: true
      diskSizeGb: 50
      initializeParams:
        sourceImage: projects/centos-cloud/global/images/centos-7-v20180104
    networkInterfaces:
    - network: $(ref.edge-network.selfLink)
      subnetwork: $(ref.edge-subnetwork-east.selfLink)
      networkIP: 10.1.0.4
      accessConfigs:
        - 
          type: ONE_TO_ONE_NAT